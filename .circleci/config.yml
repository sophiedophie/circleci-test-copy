
version: 2.1

default_config: &default_config
  machine: true

jobs:
  save-docker:
    <<: *default_config

    steps:
      - checkout
      - run:
          name: create a file
          command: echo 'hello world' > sophie.txt
      - run:
          name: docker build
          command: |
            sudo docker build . -t 'sophie:test'
            sudo docker images
      - run:
          name: docker save
          command: |
            sudo docker save sophie > sophie.tar
            ls -sh sophie.tar
      - persist_to_workspace:
          root: .
          paths:
          - .
  
  load-docker:
    <<: *default_config

    steps:
      - attach_workspace:
          at: .
      - run:
          name: check workspace attached
          command: |
            ls
            sudo docker images
      - run:
          name: docker save
          command: |
            sudo docker save --input sophie.tar
            sudo docker images

workflows:
  test-workspace:
    jobs:
      - save-docker
      - load-docker:
          requires:
            - save-docker